/// src/data/giftList.js

/** ------------------------------------------------------------------
 * 1) Your original data â€” UNCHANGED
 * ------------------------------------------------------------------*/
export const giftList = [
  {
    id: "rose",
    name: "Rose",
    icon: "/Gifts/rose.png",
    coins: 2,
    tier: "Lite",
    supportEffects: ["sparkleBurst"],
    video: {
      webm: "/video-gifts/transparent/watermarked/rose_wm.webm",
      mp4: "/video-gifts/rose.mp4"
    }
  },
  {
    id: "lolypop",
    name: "Lolypop",
    icon: "/Gifts/lolypop.png",
    coins: 2,
    tier: "Lite",
    supportEffects: ["sparkleBurst"],
    video: {
      webm: "/video-gifts/transparent/lolypop_transparent_20250625_055958.webm",
      mp4: "/video-gifts/lolypop.mp4"
    }
  },
  {
    id: "privatejet",
    name: "Private Jet",
    icon: "/Gifts/privatejet.png",
    coins: 25999,
    tier: "Mythic",
    supportEffects: ["energyPulse", "neonFrame", "spotlight", "shockWave"],
    video: {
      webm: "/video-gifts/transparent/privatejet_transparent_20250625_060150.webm",
      mp4: "/video-gifts/privatejet.mp4"
    }
  },
  {
    id: "heartwings",
    name: "Heart Wings",
    icon: "/Gifts/heartwings.png",
    coins: 10,
    tier: "Popular",
    supportEffects: ["sparkleBurst", "spotlight"],
    video: {
      webm: "/video-gifts/transparent/heart wings_transparent_20250625_055924.webm",
      mp4: "/video-gifts/heartwings.mp4"
    }
  },
 {
  id: "perfume",
  name: "Perfume",
  icon: "/Gifts/perfume.png",
  coins: 25,
  tier: "Popular",
  supportEffects: ["sparkleBurst", "spotlight"],
  video: {
    webm: "/video-gifts/transparent/perfume_transparent_20250625_060139.webm",
    mp4: "/video-gifts/perfume.mp4"
  }
},
{
  id: "moneytornado",
  name: "Money Tornado",
  icon: "/Gifts/moneytornado.png",
  coins: 8000,
  tier: "Legendary",
  supportEffects: ["shockWave", "sparkleBurst", "smokeTrail"],
  video: {
    webm: "/video-gifts/transparent/moneytonardo_transparent_20250625_060041.webm",
    mp4: "/video-gifts/moneytornado.mp4"
  }
},
{
  id: "diamonddrops",
  name: "Diamond Drops",
  icon: "/Gifts/diamonddrops.png",
  coins: 2000,
  tier: "Epic",
  supportEffects: ["spotlight", "sparkleBurst"],
  video: {
    webm: "/video-gifts/transparent/diamond drops_transparent_20250625_055830.webm",
    mp4: "/video-gifts/diamonddrops.mp4"
  }
},
{
  id: "quantumburst",
  name: "Quantum Burst",
  icon: "/Gifts/quantumburst.png",
  coins: 5000,
  tier: "Epic",
  supportEffects: ["energyPulse", "shockWave"],
  video: {
    webm: "/video-gifts/transparent/quantumburst_transparent_20250625_060105.webm",
    mp4: "/video-gifts/quantumburst.mp4"
  }
},
 {
  id: "royalchampagne",
  name: "Royal Champagne",
  icon: "/Gifts/royalchampagne.png",
  coins: 3000,
  tier: "Epic",
  supportEffects: ["spotlight", "sparkleBurst", "energyPulse"],
  video: {
    webm: "/video-gifts/transparent/royalchampagne_transparent_20250625_060229.webm",
    mp4: "/video-gifts/royalchampagne.mp4"
  }
},
{
  id: "kissgun",
  name: "Kiss Blaster",
  icon: "/Gifts/kissgun.png",
  coins: 1000,
  tier: "Rare",
  supportEffects: ["sparkleBurst", "neonFrame"],
  video: {
    webm: "/video-gifts/transparent/kissgun_transparent_20250625_055934.webm",
    mp4: "/video-gifts/kissgun.mp4"
  }
},
{
  id: "whale",
  name: "Whale Dive",
  icon: "/Gifts/whale.png",
  coins: 2000,
  tier: "Rare",
  supportEffects: ["shockWave", "smokeTrail"],
  video: {
    webm: "/video-gifts/transparent/whale_transparent_20250625_060445.webm",
    mp4: "/video-gifts/whale.mp4"
  }
},
{
  id: "rainbow",
  name: "Rainbow",
  icon: "/Gifts/rainbow.png",
  coins: 3500,
  tier: "Classic",
  supportEffects: ["neonFrame", "spotlight"],
  video: {
    webm: "/video-gifts/transparent/rainbow_transparent_20250625_060158.webm",
    mp4: "/video-gifts/rainbow.mp4"
  }
},
{
  id: "galaxyorbit",
  name: "Galaxy Orbit",
  icon: "/Gifts/galaxyorbit.png",
  coins: 12000,
  tier: "Mythic",
  supportEffects: ["energyPulse", "spotlight", "neonFrame"],
  video: {
    webm: "/video-gifts/transparent/galaxy orbit_transparent_20250625_055843.webm",
    mp4: "/video-gifts/galaxyorbit.mp4"
  }
},
{
  id: "neonriders",
  name: "Neon Riders",
  icon: "/Gifts/neonriders.png",
  coins: 18000,
  tier: "Mythic",
  supportEffects: ["neonFrame", "sparkleBurst", "smokeTrail"],
  video: {
    webm: "/video-gifts/transparent/neonriders_transparent_20250625_060128.webm",
    mp4: "/video-gifts/neonriders.mp4"
  }
},
 {
  id: "strikecommander",
  name: "Strike Commander",
  icon: "/Gifts/strikecommander.png",
  coins: 30000,
  tier: "Mythic Elite",
  supportEffects: ["energyPulse", "neonFrame", "shockWave", "sparkleBurst"],
  video: {
    webm: "/video-gifts/transparent/strike_transparent_20250625_060336.webm",
    mp4: "/video-gifts/strikecommander.mp4"
  }
},
{
  id: "eternalvows",
  name: "Eternal Vows",
  icon: "/Gifts/eternalvows.png",
  coins: 25000,
  tier: "Supreme",
  supportEffects: ["spotlight", "energyPulse", "sparkleBurst"],
  video: {
    webm: "/video-gifts/transparent/eternalvows_transparent_20250625_060020.webm",
    mp4: "/video-gifts/eternalvows.mp4"
  }
},
{
  id: "roughrider",
  name: "Rough Rider",
  icon: "/Gifts/roughrider.png",
  coins: 8000,
  tier: "Legendary",
  supportEffects: ["smokeTrail", "shockWave"],
  video: {
    webm: "/video-gifts/transparent/roughrider_transparent_20250625_060217.webm",
    mp4: "/video-gifts/roughrider.mp4"
  }
},
{
  id: "flyingfish",
  name: "Flying Fish",
  icon: "/Gifts/flyingfish.png",
  coins: 1200,
  tier: "Classic",
  supportEffects: ["sparkleBurst"],
  video: {
    webm: "/video-gifts/transparent/flying_fish_transparent_20250625_055903.webm",
    mp4: "/video-gifts/flyingfish.mp4"
  }
},
{
  id: "mystictrain",
  name: "Mystic Train",
  icon: "/Gifts/mystictrain.png",
  coins: 3000,
  tier: "Royal",
  supportEffects: ["neonFrame", "shockWave"],
  video: {
    webm: "/video-gifts/transparent/mystic_train_transparent_20250625_060054.webm",
    mp4: "/video-gifts/mystictrain.mp4"
  }
},
{
  id: "cyberphoenix",
  name: "Cyber Phoenix",
  icon: "/Gifts/cyberphoenix.png",
  coins: 10000,
  tier: "Mythic",
  supportEffects: ["energyPulse", "neonFrame", "spotlight"],
  video: {
    webm: "/video-gifts/transparent/watermarked/cyberphoenix_wm.webm",
    mp4: "/video-gifts/cyberphoenix.mp4"
  }
},
{
  id: "surprisestar",
  name: "Surprise Starburst",
  icon: "/Gifts/surprisestar.png",
  coins: 7000,
  tier: "Royal",
  supportEffects: ["sparkleBurst", "spotlight"],
  video: {
    webm: "/video-gifts/transparent/surprisestar_transparent_20250625_060549.webm",
    mp4: "/video-gifts/surprisestar.mp4"
  }
},
{
  id: "waterfallspirit",
  name: "Spirit Falls",
  icon: "/Gifts/waterfallspirit.png",
  coins: 15000,
  tier: "Mythic",
  supportEffects: ["energyPulse", "smokeTrail", "sparkleBurst"],
  video: {
    webm: "/video-gifts/transparent/spirit_falls_transparent_20250625_060325.webm",
    mp4: "/video-gifts/waterfallspirit.mp4"
  }
},
{
  id: "furiouslion",
  name: "Furious Lion",
  icon: "/Gifts/furiouslion.png",
  coins: 11000,
  tier: "Mythic",
  supportEffects: ["shockWave", "spotlight", "energyPulse"],
  video: {
    webm: "/video-gifts/transparent/lion_transparent_20250625_055946.webm",
    mp4: "/video-gifts/furiouslion.mp4"
  }
},
{
  id: "whitedove",
  name: "White Spirit Dove",
  icon: "/Gifts/whitedove.png",
  coins: 3000,
  tier: "Rare",
  supportEffects: ["sparkleBurst"],
  video: {
    webm: "/video-gifts/transparent/white_dove_transparent_20250625_060654.webm",
    mp4: "/video-gifts/whitedove.mp4"
  }
},
{
  id: "toucanbird",
  name: "Toucan Bird",
  icon: "/Gifts/toucanbird.png",
  coins: 20,
  tier: "Lite",
  supportEffects: [],
  video: {
    webm: "/video-gifts/transparent/taucan_bird_transparent_20250625_060348.webm",
    mp4: "/video-gifts/toucanbird.mp4"
  }
},
{
  id: "combatjets",
  name: "Combat Jets",
  icon: "/Gifts/combatjets.png",
  coins: 18000,
  tier: "Mythic",
  supportEffects: ["shockWave", "smokeTrail", "energyPulse"],
  video: {
    webm: "/video-gifts/transparent/combat_jets_strike_transparent_20250625_055809.webm",
    mp4: "/video-gifts/combatjets.mp4"
  }
},
{
  id: "watercar",
  name: "Water Car",
  icon: "/Gifts/watercar.png",
  coins: 5000,
  tier: "Royal",
  supportEffects: ["sparkleBurst", "shockWave"],
  video: {
    webm: "/video-gifts/transparent/watercar_transparent_20250625_060410.webm",
    mp4: "/video-gifts/watercar.mp4"
  }
},
{
  id: "aikingdom",
  name: "AI Kingdom",
  icon: "/Gifts/aikingdom.png",
  coins: 49999,
  tier: "Supreme",
  supportEffects: ["energyPulse", "neonFrame", "spotlight"],
  video: {
    webm: "/video-gifts/transparent/aikingdom_transparent_20250625_055720.webm",
    mp4: "/video-gifts/aikingdom.mp4"
  }
},
{
  id: "weddingring",
  name: "Wedding Ring",
  icon: "/Gifts/weddingring.png",
  coins: 9000,
  tier: "Royal",
  supportEffects: ["sparkleBurst", "spotlight"],
  video: {
    webm: "/video-gifts/transparent/wedding_ring_transparent_20250625_060423.webm",
    mp4: "/video-gifts/weddingring.mp4"
  }
},
{
  id: "luxurycar",
  name: "Luxury Car",
  icon: "/Gifts/luxurycar.png",
  coins: 20000,
  tier: "Supreme",
  supportEffects: ["neonFrame", "shockWave", "spotlight"],
  video: {
    webm: "/video-gifts/transparent/luxury_car_transparent_20250625_060007.webm",
    mp4: "/video-gifts/luxurycar.mp4"
  }
},
{
  id: "celestialhorse",
  name: "Celestial Horse",
  icon: "/Gifts/celestialhorse.png",
  coins: 25000,
  tier: "Mythic",
  supportEffects: ["energyPulse", "sparkleBurst", "spotlight"],
  video: {
    webm: "/video-gifts/transparent/celestial_horse_transparent_20250625_055800.webm",
    mp4: "/video-gifts/celestialhorse.mp4"
  }
},
{
  id: "smartbizuniversal",
  name: "SmartBiz Universal Studios",
  icon: "/Gifts/smartbizuniversal.png",
  coins: 28000,
  tier: "Supreme",
  supportEffects: ["neonFrame", "sparkleBurst", "energyPulse"],
  video: {
    webm: "/video-gifts/transparent/universe_transparent_20250625_060359.webm",
    mp4: "/video-gifts/smartbizuniversal.mp4"
  }
}
]

/** ------------------------------------------------------------------
 * 2) Mobile-first, hi-tech helpers (non-breaking). All optional.
 *    - Performance-aware media selection (save-data, reduced-motion)
 *    - Robust lookups (aliases), indexing, sorting, search
 *    - Prefetch/preload helpers for icons/videos
 *    - Effect fallbacks for low-tier devices (no external deps)
 * ------------------------------------------------------------------*/

/** @typedef {{ id:string; name:string; icon:string; coins:number; tier:string; supportEffects:string[]; video:{ webm:string; mp4:string } }} Gift */

/** Freeze to avoid accidental mutation in runtime stores */
giftList.forEach(g => (Object.freeze(g.video), Object.freeze(g)))
Object.freeze(giftList)

/** Tier order for consistent sorting (mobile store layout) */
export const tierOrder = [
  'Lite','Popular','Rare','Classic','Royal','Epic','Legendary','Mythic','Mythic Elite','Supreme'
]

/** Indexes */
export const giftById = giftList.reduce((m, g) => (m[g.id] = g, m), /** @type {Record<string, Gift>} */({}))
export const giftsByTier = tierOrder.reduce((m, t) => (m[t] = giftList.filter(g => g.tier === t), m), /** @type {Record<string, Gift[]>} */({}))

/** Common alias map (so you can be forgiving in lookups without changing data) */
export const giftAlias = {
  lollipop: 'lolypop',
  toucan: 'toucanbird',
  toucanbird: 'toucanbird',
  diamonddrops: 'diamonddrops',
  moneytornado: 'moneytornado',
  heartwings: 'heartwings',
  galaxy: 'galaxyorbit',
  universe: 'smartbizuniversal'
}

/** Safe lookup */
export function getGift(key) {
  if (giftById[key]) return giftById[key]
  const alias = giftAlias[key?.toLowerCase?.()] || giftAlias[key]
  return alias ? giftById[alias] : undefined
}

/** Lightweight search (name/id/tier) */
export function searchGifts(q) {
  const term = (q || '').trim().toLowerCase()
  if (!term) return giftList
  return giftList.filter(g =>
    g.name.toLowerCase().includes(term) ||
    g.id.toLowerCase().includes(term) ||
    g.tier.toLowerCase().includes(term)
  )
}

/** Sort helpers */
export function sortByTierThenPrice(list = giftList, dir = 'asc') {
  const sgn = dir === 'desc' ? -1 : 1
  return [...list].sort((a,b) => {
    const t = tierOrder.indexOf(a.tier) - tierOrder.indexOf(b.tier)
    return t !== 0 ? t : sgn * (a.coins - b.coins)
  })
}

/** Budget recommendations (coins) */
export function recommendByBudget(budgetCoins, max = 8) {
  return sortByTierThenPrice(giftList.filter(g => g.coins <= budgetCoins), 'desc').slice(0, max)
}

/** --- Device & network awareness for mobile-first media selection --- */
const support = {
  reducedMotion: typeof window !== 'undefined' && window.matchMedia?.('(prefers-reduced-motion: reduce)').matches,
  saveData: (navigator && navigator.connection && navigator.connection.saveData) || false,
  effectiveType: (navigator && navigator.connection && navigator.connection.effectiveType) || '4g'
}

/** choose best video source for current device/network */
export function selectGiftMedia(gift, opts = {}) {
  const preferWebm = supportsWebM() && !support.saveData
  const lowNet = ['2g','slow-2g','3g'].includes(support.effectiveType)
  const reduced = support.reducedMotion

  // If user prefers reduced motion or very slow network, prefer icon-only (poster thumbnails)
  if (opts.iconOnly || reduced || lowNet) {
    return { mode: 'icon', poster: gift.icon }
  }

  // Try to sanitize known path quirks as fallbacks without changing your data
  const candWebm = sanitizePathCandidates(gift.video.webm, gift)
  const candMp4  = sanitizePathCandidates(gift.video.mp4, gift)

  if (preferWebm) {
    return { mode: 'video', type: 'webm', src: candWebm[0], fallbacks: candWebm.slice(1).concat(candMp4) }
  } else {
    return { mode: 'video', type: 'mp4',  src: candMp4[0],  fallbacks: candMp4.slice(1).concat(candWebm) }
  }
}

/** Simple support check */
function supportsWebM() {
  try {
    const v = document.createElement('video')
    return !!v.canPlayType && (v.canPlayType('video/webm; codecs="vp9"') || v.canPlayType('video/webm')).length > 0
  } catch { return false }
}

/** Sanitize common filename inconsistencies to provide graceful fallback attempts */
function sanitizePathCandidates(path, gift) {
  const candidates = [path]
  const baseFixes = [
    s => s.replace(/heart wings/gi, 'heartwings'),
    s => s.replace(/diamond drops/gi, 'diamonddrops'),
    s => s.replace(/galaxy orbit/gi, 'galaxyorbit'),
    s => s.replace(/taucan/gi, 'toucan'),
    s => s.replace(/moneytonardo/gi, 'moneytornado'),
    s => s.replace(/\s+/g, '_')
  ]
  baseFixes.forEach(f => {
    const p = f(path)
    if (!candidates.includes(p)) candidates.push(p)
  })
  // also try swapping to the other format via id (same folder structure)
  const idSwap = path.endsWith('.webm') ? path.replace(/[^/]+\.webm$/, `${gift.id}.webm`)
               : path.endsWith('.mp4')  ? path.replace(/[^/]+\.mp4$/,  `${gift.id}.mp4`)
               : path
  if (!candidates.includes(idSwap)) candidates.push(idSwap)
  return candidates
}

/** Prefetch helpers (icons/videos) â€” polite on mobile */
export function prefetchGiftAssets(gift, { video = false } = {}) {
  // Always prefetch icon (tiny)
  addPrefetchLink(gift.icon, 'image')
  if (video) {
    const sel = selectGiftMedia(gift)
    if (sel.mode === 'video') {
      addPrefetchLink(sel.src, 'video')
      // one fallback only to keep it light
      if (sel.fallbacks?.[0]) addPrefetchLink(sel.fallbacks[0], 'video')
    }
  }
}
function addPrefetchLink(href, as) {
  try {
    const l = document.createElement('link')
    l.rel = 'prefetch'; l.href = href; if (as) l.as = as
    document.head.appendChild(l)
  } catch {}
}

/** Build <source> descriptors for a <video> element */
export function buildVideoSources(gift) {
  const sel = selectGiftMedia(gift)
  if (sel.mode !== 'video') return []
  const list = [sel.src].concat(sel.fallbacks || [])
  return list.map(src => ({ src, type: src.endsWith('.webm') ? 'video/webm' : 'video/mp4' }))
}

/** Minimal effect fallback logic (no external registry required) */
export function chooseEffectsForDevice(gift) {
  const lowNet = ['2g','slow-2g','3g'].includes(support.effectiveType)
  const lowMotion = support.reducedMotion || support.saveData || lowNet
  const effects = gift.supportEffects || []
  if (!effects.length) return effects
  if (lowMotion) {
    // Prefer light effects on constrained devices
    const lightFirst = ['sparkleBurst','neonFrame','spotlight','smokeTrail','energyPulse','shockWave']
    return effects.slice().sort((a,b) => lightFirst.indexOf(a) - lightFirst.indexOf(b))
                   .filter((e,i) => i < 2) // cap to 2 effects on low devices
  }
  return effects
}

/** Format coins (optionally map to TZS for display) */
export function formatCoins(coins, { tzsRate = null } = {}) {
  if (tzsRate) {
    const amt = coins * tzsRate
    return new Intl.NumberFormat('en-TZ', { style:'currency', currency:'TZS', maximumFractionDigits:0 }).format(amt)
  }
  return `${coins.toLocaleString()} coins`
}

/** Tiny validator â€” doesnâ€™t mutate your data; returns an array of notes */
export function validateGiftList() {
  const notes = []
  for (const g of giftList) {
    if (!g.id || !g.name || !g.icon || !g.video?.mp4 || !g.video?.webm) {
      notes.push({ id: g.id, issue: 'Missing required fields' })
    }
    if (/\s/.test(g.id)) notes.push({ id: g.id, issue: 'ID contains whitespace' })
    // flag common filename oddities (just informational)
    if (/\s/.test(g.video.webm)) notes.push({ id: g.id, issue: 'WEBM path has spaces (ok but uncommon)' })
    if (/moneytonardo/.test(g.video.webm)) notes.push({ id: g.id, issue: 'Possible typo in WEBM filename (moneytonardo)' })
    if (/taucan/.test(g.video.webm)) notes.push({ id: g.id, issue: 'Possible typo in WEBM filename (taucan)' })
    if (/diamond drops/.test(g.video.webm)) notes.push({ id: g.id, issue: 'Space in WEBM filename (diamond drops)' })
    if (/galaxy orbit/.test(g.video.webm)) notes.push({ id: g.id, issue: 'Space in WEBM filename (galaxy orbit)' })
    if (/heart wings/.test(g.video.webm)) notes.push({ id: g.id, issue: 'Space in WEBM filename (heart wings)' })
  }
  return notes
}
